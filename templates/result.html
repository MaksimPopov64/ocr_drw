<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Результат обработки документа</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-clipboard-check"></i> Результат проверки документа</h1>
            <p>Результаты автоматической обработки акта выполненных работ</p>
        </div>

        <div class="card">
            <!-- Безопасная проверка статуса -->
            {% set status = result.get('status', result.get('check_result', {}).get('status', 'UNKNOWN')) %}
            {% if status == 'APPROVED' %}
                <div class="status-badge status-approved">
                    <i class="fas fa-check-circle"></i> ДОКУМЕНТ ПРИНЯТ
                </div>
            {% elif status == 'REJECTED' %}
                <div class="status-badge status-rejected">
                    <i class="fas fa-times-circle"></i> ДОКУМЕНТ ОТКЛОНЕН
                </div>
            {% elif status == 'NEEDS_REVIEW' %}
                <div class="status-badge status-review">
                    <i class="fas fa-exclamation-triangle"></i> ТРЕБУЕТСЯ ПРОВЕРКА
                </div>
            {% else %}
                <div class="status-badge" style="background: #6c757d; color: white;">
                    <i class="fas fa-question-circle"></i> СТАТУС НЕИЗВЕСТЕН
                </div>
            {% endif %}

            <!-- Безопасное получение данных -->
            {% set parsed_data = result.get('parsed_data', {}) %}
            {% if not parsed_data and result.get('data') %}
                {% set parsed_data = result.get('data', {}) %}
            {% endif %}
            
            {% set check_result = result.get('check_result', {}) %}
            {% set decision = check_result.get('decision', {}) %}

            <div class="result-grid">
                <div class="result-card">
                    <h4><i class="fas fa-info-circle"></i> Основная информация</h4>
                    <ul>
                        <li><strong>Номер заявки:</strong> {{ parsed_data.get('claim_number', 'Не найден') }}</li>
                        <li><strong>Модель оборудования:</strong> {{ parsed_data.get('equipment_model', 'Не найдена') }}</li>
                        <li><strong>Картридж:</strong> {{ parsed_data.get('cartridge_model', 'Не найден') }}</li>
                        <li><strong>Количество страниц:</strong> {{ parsed_data.get('page_count', 'N/A') }}</li>
                        <li><strong>Тип работ:</strong> {{ parsed_data.get('work_type', 'N/A') }}</li>
                    </ul>
                </div>

                <div class="result-card">
                    <h4><i class="fas fa-check-double"></i> Проверка документа</h4>
                    <ul>
                        <li><strong>Подпись клиента:</strong> 
                            {% if parsed_data.get('signature_status') == 'FOUND' or parsed_data.get('has_signature') %}
                                <span style="color: green;"><i class="fas fa-check"></i> Найдена</span>
                            {% else %}
                                <span style="color: red;"><i class="fas fa-times"></i> Не найдена</span>
                            {% endif %}
                        </li>
                        <li><strong>Печать клиента:</strong> 
                            {% if parsed_data.get('stamp_status') == 'FOUND' or parsed_data.get('has_stamp') %}
                                <span style="color: green;"><i class="fas fa-check"></i> Найдена</span>
                            {% else %}
                                <span style="color: orange;"><i class="fas fa-exclamation"></i> Не найдена</span>
                            {% endif %}
                        </li>
                        <li><strong>Дата обработки:</strong> 
                            {% if result.get('timestamp') %}
                                {{ result['timestamp'][:19].replace('T', ' ') }}
                            {% else %}
                                N/A
                            {% endif %}
                        </li>
                        <li><strong>Движок OCR:</strong> {{ result.get('ocr_engine', 'Tesseract/EasyOCR') }}</li>
                    </ul>
                </div>

                <div class="result-card">
                    <h4><i class="fas fa-clipboard-list"></i> Решение системы</h4>
                    <p><strong>{{ decision.get('message', 'Решение не сформировано') }}</strong></p>
                    {% if decision.get('steps') %}
                    <h5 style="margin-top: 15px;">Действия:</h5>
                    <ul>
                        {% for step in decision.get('steps', []) %}
                        <li>{{ step }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
            </div>

            {% if check_result.get('issues') %}
            <div style="margin-top: 30px;">
                <h4><i class="fas fa-exclamation-triangle"></i> Найденные проблемы:</h4>
                {% for issue in check_result.get('issues', []) %}
                <div class="issue-item {% if issue.get('severity') == 'ERROR' %}issue-error{% else %}issue-warning{% endif %}">
                    <strong>{{ issue.get('code', 'UNKNOWN') }}:</strong> {{ issue.get('message', 'Без описания') }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if check_result.get('warnings') %}
            <div style="margin-top: 30px;">
                <h4><i class="fas fa-info-circle"></i> Предупреждения:</h4>
                {% for warning in check_result.get('warnings', []) %}
                <div class="issue-item issue-warning">
                    <strong>{{ warning.get('code', 'UNKNOWN') }}:</strong> {{ warning.get('message', 'Без описания') }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div style="margin-top: 30px; text-align: center;">
                {% if file_id %}
                <a href="{{ url_for('download_result', file_id=file_id) }}" class="btn">
                    <i class="fas fa-download"></i> Скачать результат (JSON)
                </a>
                {% endif %}
                
                <a href="{{ url_for('index') }}" class="btn" style="margin-left: 10px; background: #6c757d;">
                    <i class="fas fa-upload"></i> Загрузить новый документ
                </a>
            </div>
        </div>

        <div class="card">
            <h4><i class="fas fa-file-alt"></i> Распознанный текст:</h4>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 10px; max-height: 300px; overflow-y: auto;">
                <pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px;">
{{ parsed_data.get('full_text', result.get('parsed_data', {}).get('full_text', 'Текст не распознан')) }}
                </pre>
            </div>
        </div>

        <!-- Отладочная информация (можно скрыть в продакшене) -->
        <div class="card" style="background: #f8f9fa; font-size: 12px;">
            <h4><i class="fas fa-bug"></i> Отладочная информация</h4>
            <details>
                <summary>Показать структуру данных</summary>
                <pre style="background: #fff; padding: 10px; border-radius: 5px; overflow: auto;">
{{ result|tojson(indent=2) }}
                </pre>
            </details>
        </div>
    </div>
</body>
</html>